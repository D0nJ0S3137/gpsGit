<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Históricos</title>
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

   <style>
    #mapid {
        height: 85vh; 
        width: 100vw;
    }
    .container-map, .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 0 ; /* Reduced side padding */
    }
    .card {
        box-shadow: none; 
        border: none; 
    }
    .card-body{
        padding: 10px;
    }
    .form-label{
        margin-bottom: 0.5rem;
    }
    .form-inline-custom {
        display: flex;
        gap: 10px;
        flex-wrap: wrap; 
        align-items: center; 
        justify-content: center; 
    }
    .btn-custom {
        padding: .375rem .75rem; 
    }
    .small-title{
        font-size: 24px;
    }
    #startDateSpan, #startTimeSpan, #endDateSpan, #endTimeSpan {
        display: none;
    }
    .date-time-info {
        position: absolute;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
    }
    .navbar {
        padding: 0.5rem 1rem; /* Adjust the padding to make the navbar smaller */
    }
    .form-inline-custom .form-control, .form-inline-custom .btn-custom {
        margin-bottom: 0;
    }

    @media (min-width: 768px) { 
        .container-map {
            padding: 10px;
        }
        .navbar-nav {
            flex-direction: column;
        }
        .form-inline-custom .form-control {
            max-width: 165px;
        }
    }
    .row1{
        display: flex;
        justify-content: space-between;
    }
    .btn-consistent-size {
    padding: .375rem .75rem; 
    }
    #timeSlider {
    display: none;
    }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <div style="display: flex; align-items: center;">
            <a class="navbar-brand" href="#">
                <span>GeoTracker GPS</span>
            </a>
            <img src="/image_cleanup.png" alt="Geo Tracker Logo" style="height: 60px; border-radius: 50%; margin-left: 10px;">
        </div>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
            <ul class="navbar-nav">
                <a type="button" class="btn btn-primary btn-consistent-size me-2" href="/">
                    <b>Página Principal</b>
                </a>
                <button type="button" class="btn btn-info btn-consistent-size" data-bs-toggle="modal" data-bs-target="#instructionsModal">
                    <b>Instrucciones de Usuario</b>
                </button>
            </ul>
        </div>
    </div>
</nav>
    
<div class="container-map">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center my-3 small-title">Consulta de Recorridos</h1>
        </div>
    </div>
</div>
<div class="container">
    <div class="row justify-content-center mb-3">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div id="timeWindowForm" class="row">
                        <div class="col-md-4">
                            <label for="startDateTime" class="form-label">Fecha y hora de inicio:</label>
                            <input type="text" id="startDateTime" onchange="updateDateTimeDisplay()" required>
                        </div>
                        <div class="col-md-4">
                            <label for="endDateTime" class="form-label">Fecha y hora de fin:</label>
                            <input type="text" id="endDateTime" onchange="updateDateTimeDisplay()" required>
                        </div>
                        <span id="startDateSpan"></span> <span id="startTimeSpan"></span>
                        <span id="endDateSpan"></span> <span id="endTimeSpan"></span>
                        <div class="col-md-4 d-flex align-items-end"> 
                            <button type="submit" id="submitButton" class="btn btn-primary btn-custom btn-sm w-100">Mostrar en mapa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionsModalLabel">Cómo usar la Consulta de Recorridos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Bienvenid@ a la Consulta de Recorridos. Aquí debes:
          <ul>
            <li>Seleccionar rango de fecha y hora de inicio y fin para ver el recorrido histórico del vehículo.</li>
            <li>Dar click en Mostrar en mapa.</li>
            <li>Usar el botón deslizante para moverte a través del recorrido del vehículo y visualizar la fecha y el tiempo donde estuvo en cierto lugar.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<div class="container">
    <div class="row justify-content-center my-3">
        <div class="col-lg-8">
            <input type="range" class="form-range" min="0" max="100" value="0" id="timeSlider">
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="mapid"></div>
        </div>
    </div>
</div>

<div id="dateError" class="text-danger"></div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// Inicialización de Flatpickr para la fecha de inicio
var startFlatpickr = flatpickr("#startDateTime", {
    enableTime: true,
    dateFormat: "Y-m-dTH:i",
    altInput: true,
    altFormat: "Y-m-d H:i",
    time_24hr: false,
    minuteIncrement: 15,
    altInputClass: "form-control form-control-sm",
    onChange: function(selectedDates) {
        // Cuando se selecciona una nueva fecha de inicio, actualiza la fecha mínima del calendario de fecha de fin
        endFlatpickr.set('minDate', selectedDates[0]);
    }
});

// Inicialización de Flatpickr para la fecha de fin
var endFlatpickr = flatpickr("#endDateTime", {
    enableTime: true,
    dateFormat: "Y-m-dTH:i",
    altInput: true,
    altFormat: "Y-m-d H:i",
    time_24hr: false,
    minuteIncrement: 15,
    altInputClass: "form-control form-control-sm",
    // Se puede especificar una fecha mínima inicial si es necesario, por ejemplo, la fecha actual
    minDate: "today"
});


    // cambio para desconcatenar los calendarios
    document.addEventListener('DOMContentLoaded', () => {
    const startDateTimeInput = document.getElementById('startDateTime');
    const endDateTimeInput = document.getElementById('endDateTime');
    const submitButton = document.getElementById('submitButton');
    const errorMessage = document.getElementById('dateError');

    submitButton.addEventListener('click', (event) => {
        event.preventDefault(); // Prevenir el envío del formulario por defecto
        
        const startDateTime = new Date(startDateTimeInput.value);
        const endDateTime = new Date(endDateTimeInput.value);

        if (startDateTime > endDateTime) {
            errorMessage.innerText = "La fecha de inicio no puede ser posterior a la fecha de fin.";
        } else {
            errorMessage.innerText = ""; // Limpiar el mensaje de error si las fechas son válidas
        }
    });

    // Bloquear la entrada de fechas futuras en el campo "Fecha y hora de inicio"
    const today = new Date().toISOString().split('T')[0]; // Obtener la fecha actual en formato ISO
    startDateTimeInput.setAttribute('min', today);
    
    // Bloquear la entrada de fechas anteriores a la fecha de inicio en el campo "Fecha y hora de fin"
    startDateTimeInput.addEventListener('change', () => {
        endDateTimeInput.setAttribute('min', startDateTimeInput.value);
    });
});
</script>

<script>
    let markers = [];
    let trayectos = []; // Almacena las polilíneas de cada trayecto
    let rutaActual;
    let decoradores = []; // Almacena las instancias de los decoradores de flechas


    document.addEventListener('DOMContentLoaded', () => {
        const myMap = L.map('mapid').setView([11.02115114, -74.84057200], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(myMap);

        document.getElementById('submitButton').addEventListener('click', (event) => {
            event.preventDefault(); // Previene la acción por defecto del formulario
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;

            // Actualiza y muestra la fecha y hora seleccionadas
            updateDateTimeDisplay(startDateTime, endDateTime);

            // Carga los datos para el intervalo de tiempo seleccionado
            cargarDatos(startDateTime, endDateTime, myMap);
        });
        if (!localStorage.getItem('hasSeenInstructions')) {
            console.log('Mostrando modal');
            var myModal = new bootstrap.Modal(document.getElementById('instructionsModal'), {
                keyboard: false
            });
            myModal.show();
            localStorage.setItem('hasSeenInstructions', 'true');
        }
    });

    let marcadorDeslizable; //definición de marcador deslizable
        function cargarDatos(startDateTime, endDateTime, myMap) {
            const link = `/consulta-historicos?startDateTime=${startDateTime}&endDateTime=${endDateTime}`; 
            fetch(link)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    if (data.length > 0) {
                        // Eliminar trayectos existentes y limpiar el arreglo
                        trayectos.forEach(trayecto => trayecto.remove());
                        trayectos = [];

                        // Eliminar marcadores existentes y limpiar el arreglo
                        markers.forEach(marker => marker.remove());
                        markers = [];

                        decoradores.forEach(decorador => decorador.remove());
                        decoradores = [];

                        rutaActual = L.polyline([], {
                            color: 'blue',      // Cambia el color a azul o el que prefieras
                            weight: 3,          // Ajusta el grosor de la línea
                            opacity: 0.7,       // Ajusta la opacidad de la línea
                            lineJoin: 'round',  // Establece cómo se unen los segmentos de la línea ('miter' es predeterminado, 'round' o 'bevel')
                        }).addTo(myMap);

                        trayectos.push(rutaActual);

                        let ultimoPunto = null;
                        data.forEach(point => {
                            const lat = parseFloat(point.Latitude); 
                            const lng = parseFloat(point.Longitude);
                            const nuevoPunto = L.latLng(lat, lng);

                            if (ultimoPunto && myMap.distance(ultimoPunto, nuevoPunto) > 500) {
                                if (ultimoPunto) {
                        let decorador = L.polylineDecorator(rutaActual, {
                            patterns: [
                                {offset: '5%', repeat: '50px', symbol: L.Symbol.arrowHead({pixelSize: 10, pathOptions: {opacity: 0.7, color: 'blue', weight: 3}})}
                            ]
                        }).addTo(myMap);
                        decoradores.push(decorador);
                    }
                    
                    // Comienza un nuevo segmento
                    rutaActual = L.polyline([], { color: 'blue', weight: 3, opacity: 0.7, lineJoin: 'round' }).addTo(myMap);
                    trayectos.push(rutaActual);
                }

                // Añade el nuevo punto al segmento actual
                rutaActual.addLatLng(nuevoPunto);
                ultimoPunto = nuevoPunto;
            });

            // Decora el último segmento después de salir del bucle forEach
            if (rutaActual.getLatLngs().length > 0) {
                let decorador = L.polylineDecorator(rutaActual, {
                    patterns: [
                        {offset: '5%', repeat: '50px', symbol: L.Symbol.arrowHead({pixelSize: 10, pathOptions: {opacity: 0.7, color: 'blue', weight: 3}})}
                    ]
                }).addTo(myMap);
                decoradores.push(decorador);
            }
                        //implementación de slider
                        if (!marcadorDeslizable) {
                            marcadorDeslizable = L.marker([0, 0], {
                                draggable: 'true',
                            }).addTo(myMap);
                        }
                        const slider = document.getElementById('timeSlider');
                        slider.max = data.length - 1;
                        slider.value = 0;

                        slider.oninput = function() {
                            const puntoSeleccionado = data[this.value];
                            const latLng = L.latLng(puntoSeleccionado.Latitude, puntoSeleccionado.Longitude);
                            marcadorDeslizable.setLatLng(latLng);
                            marcadorDeslizable.bindPopup(`Fecha y Hora de Paso: ${puntoSeleccionado.DateTime}`).openPopup(); 
                            myMap.setView(latLng, myMap.getZoom());
                        };

                        slider.oninput();

                        document.getElementById('timeSlider').style.display = 'block'; 
                    } else {
                        alert("No hay datos de ruta disponibles para la ventana de tiempo seleccionada.");
                        document.getElementById('timeSlider').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error en fetch o procesando data:', error);
                    alert("Hubo un problema al cargar los datos.");
                    document.getElementById('timeSlider').style.display = 'none';
                });
        }
    function updateDateTimeDisplay() {
        const startDateTimeStr = document.getElementById('startDateTime').value;
        const endDateTimeStr = document.getElementById('endDateTime').value;

        if (startDateTimeStr && endDateTimeStr) {
                const [startDate, startTime] = startDateTimeStr.split(' ');
                const [endDate, endTime] = endDateTimeStr.split(' ');

                document.getElementById('startDateSpan').textContent = startDate;
                document.getElementById('startTimeSpan').textContent = startTime;
                document.getElementById('endDateSpan').textContent = endDate;
                document.getElementById('endTimeSpan').textContent = endTime;
        }
    }
</script>